---

#- name: is client online? 
#  command: ping -c 3 "{{ hostname_client }}" 
#  delegate_to: 127.0.0.1
#  register: pingresult
#  ignore_errors: true
#
#
#- name: shutdown client
#  command: /sbin/poweroff 
#  delegate_to: "{{ hostname_client }}"
#  ignore_errors: True
#  when: pingresult.rc == 0
#
#- name: abwarten 
#  pause:
#    minutes: 1

###########################################################################
- name: configure DHCP-Server for unattended client installation
  template:
    src: 'dhcpd.declare-host.j2'
    dest: '/etc/dhcp/dhcpd.{{ hostname_client }}.conf'

- name: include host_declaration_file in dhcpd.conf
  blockinfile:
    dest: /etc/dhcp/dhcpd.conf
    backup: yes
    mode: 0640
    state: present
    marker: "# {mark} ANSIBLE MANAGED BLOCK <DHCP>"
    block: |

       include "/etc/dhcp/dhcpd.{{ hostname_client }}.conf";  
      
    insertafter: ".*Deklarationen mit Ansible.*"	

- name: check dhcpd.conf
  command: dhcpd -t 
  register: dhcpdstatus
  ignore_errors: true


- name: restart dhcpd service
  command: service dhcpd restart 
  when: dhcpdstatus.rc == 0


- name: Client mit WOL starten
  command: /usr/bin/wakeonlan -i {{ item}} -p 40000 {{ macaddress_client }}
  with_items:
   - "192.168.100.255"
   - "192.168.110.255"
   - "192.168.120.255"
   - "192.168.130.255"
   - "192.168.140.255"
  delegate_to: localhost

- name: abwarten bis Installation gestartet ist
  pause:
    minutes: 1


- name: remove host_declaration_file in dhcpd.conf
  blockinfile:
    dest: /etc/dhcp/dhcpd.conf
    backup: yes
    mode: 0640
    state: absent
    marker: "# {mark} ANSIBLE MANAGED BLOCK <DHCP>"
    block: |

       include "/etc/dhcp/dhcpd.{{ hostname_client }}.conf";  
      
    insertafter: ".*Deklarationen mit Ansible.*"


- name: check dhcpd.conf
  command: dhcpd -t 
  register: dhcpdstatus
  ignore_errors: true


- name: restart dhcpd service
  command: service dhcpd restart 
  when: dhcpdstatus.rc == 0	



